<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Internet Offers</title>
    <style>
        /* Highlight active buttons */
        #speed-buttons button.active,
        #limit-buttons button.active,
        #duration-buttons button.active {
            background-color: #007bff;
            color: white;
        }
    </style>
</head>
<body>
    <h1>Compare offers</h1>
    <!-- Filter form -->
    <div id="filters">
        <!-- Minimum speed filter -->
        <label for="speed">Min. speed (Mbps):</label>
        <div id="speed-buttons">
            <button type="button" data-speed="">All</button>
            <button type="button" data-speed="20">from 20</button>
            <button type="button" data-speed="50">from 50</button>
            <button type="button" data-speed="100">from 100</button>
            <button type="button" data-speed="150">from 150</button>
            <button type="button" data-speed="250">from 250</button>
        </div>    

        <!-- Data limit filter -->
        <label>Limit (GB):</label>
        <div id="limit-buttons">
            <button type="button" data-limit="">All</button>
            <button type="button" data-limit="100">100</button>
            <button type="button" data-limit="200">200</button>
            <button type="button" data-limit="300">300</button>
            <button type="button" data-limit="none">None</button>
        </div>

        <!-- Connection type filter -->
        <label>Connection type:</label>
        <div id="connection-type-checkboxes">
            <label><input type="checkbox" value="dsl" class="connection-type"> DSL</label>
            <label><input type="checkbox" value="fiber" class="connection-type"> Fiber</label>
            <label><input type="checkbox" value="cable" class="connection-type"> Cable</label>
        </div>

        <label>Max. contract duration:</label>
        <div id="duration-buttons">
            <button type="button" data-duration="">Any</button>
            <button type="button" data-duration="11">Less than a year</button>
            <button type="button" data-duration="12">12 months</button>
            <button type="button" data-duration="24">24 months</button>
        </div>

        <!-- Installation included filter -->
        <label for="installation_included">
            <input type="checkbox" id="installation_included" name="installation_included">
            Installation included
        </label>
    </div>
    
    <!-- Shareable URL field -->
    <div id="share">
        <label for="share_url">Share this link:</label>
        <input type="text" id="share_url" readonly style="width: 80%;">
    </div>
    
    <!-- Results table -->
    <table id="results" border="1" cellpadding="5" cellspacing="0">
        <thead>
            <tr>
                <th>Name</th>
                <th>Speed (Mbps)</th>
                <th>Cost in first years (€)</th>
                <th>Installation included</th>
                <th>TV</th>
                <th>Limit (GB)</th>
                <th>Connection type</th>
                <th>Max age</th>
                <th>Price after two years (€)</th>
                <th>Minimal duration (months)</th>
            </tr>
        </thead>
        <tbody>
            <!-- Rows will be dynamically inserted here -->
        </tbody>
    </table>

    <script>
        // References to filter elements
        const installCheckbox = document.getElementById('installation_included');
        const speedButtons = document.querySelectorAll('#speed-buttons button');
        const limitButtons = document.querySelectorAll('#limit-buttons button');
        const connectionTypeCheckboxes = document.querySelectorAll('.connection-type');
        const durationButtons = document.querySelectorAll('#duration-buttons button');

        // State variables for selected filters
        let selectedSpeed = ""; // Default: all speeds
        let selectedLimit = ""; // Default: all limits
        let selectedMaxDuration = ""; // Default: any

        // Helper function to get selected connection types
        function getSelectedConnectionTypes() {
            return Array.from(connectionTypeCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
        }

        // Function to trigger search and update results
        function triggerSearch() {
            const installOnly = installCheckbox.checked;

            // Build query parameters
            const params = new URLSearchParams();
            if (selectedSpeed) params.set('speed', selectedSpeed);
            params.set('installation', installOnly);
            if (selectedLimit === "none") {
                params.set('limit', "none");
            } else if (selectedLimit) {
                params.set('limit', selectedLimit);
            }
            if (selectedMaxDuration) {
                params.set('duration', selectedMaxDuration);
            }
            const selectedTypes = getSelectedConnectionTypes();
            if (selectedTypes.length > 0) {
                params.set('connection_types', selectedTypes.join(','));
            }

            // Update URL and fetch data
            const apiUrl = `/offers?${params.toString()}`;
            window.history.replaceState({}, '', `?${params.toString()}`);
            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not OK');
                    }
                    return response.json();
                })
                .then(data => updateResults(data))
                .catch(err => console.error('Fetch error:', err));
        }

        // Function to update results table
        function updateResults(data) {
            const tbody = document.getElementById('results').querySelector('tbody');
            const shareInput = document.getElementById('share_url');
            tbody.innerHTML = ''; // Clear existing rows

            // Populate table with new data
            data.forEach(offer => {
                const tr = document.createElement('tr');
                function addCell(text) {
                    const td = document.createElement('td');
                    td.textContent = text;
                    tr.appendChild(td);
                }
                addCell(offer.name);
                addCell(offer.speed_mbps);
                addCell(offer.cost_first_years_eur);
                addCell(offer.installation_included ? 'Yes' : 'No');
                addCell(offer.tv ?? '');
                addCell(offer.limit_from_gb);
                addCell(offer.connection_type ?? '');
                addCell(offer.max_age ?? '');
                addCell(offer.after_two_years_eur ?? '');
                addCell(offer.duration_months ?? '');
                tbody.appendChild(tr);
            });

            // Update shareable URL
            shareInput.value = window.location.href;
        }

        // Initialize filters and event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize connection type checkboxes
            const typesFromUrl = getParam('connection_types', '').split(',').filter(Boolean);
            connectionTypeCheckboxes.forEach(cb => {
                cb.checked = typesFromUrl.includes(cb.value);
                cb.addEventListener('change', triggerSearch);
            });

            // Initialize speed buttons
            selectedSpeed = getParam('speed', "");
            speedButtons.forEach(b => {
                if (b.dataset.speed === selectedSpeed) b.classList.add('active');
                else b.classList.remove('active');
                b.addEventListener('click', () => {
                    selectedSpeed = b.dataset.speed;
                    speedButtons.forEach(btn => btn.classList.remove('active'));
                    b.classList.add('active');
                    triggerSearch();
                });
            });

            // Initialize limit buttons
            selectedLimit = getParam('limit', "");
            limitButtons.forEach(b => {
                if (b.dataset.limit === selectedLimit) b.classList.add('active');
                else b.classList.remove('active');
                b.addEventListener('click', () => {
                    selectedLimit = b.dataset.limit;
                    limitButtons.forEach(btn => btn.classList.remove('active'));
                    b.classList.add('active');
                    triggerSearch();
                });
            });

            // Initialize duration buttons
            selectedMaxDuration = getParam('duration', "");
            durationButtons.forEach(b => {
                if (b.dataset.duration === selectedMaxDuration) b.classList.add('active');
                else b.classList.remove('active');
                b.addEventListener('click', () => {
                    selectedMaxDuration = b.dataset.duration;
                    durationButtons.forEach(btn => btn.classList.remove('active'));
                    b.classList.add('active');
                    triggerSearch();
                });
            });

            // Initialize installation checkbox
            installCheckbox.checked = getParam('installation', 'false') === 'true';
            installCheckbox.addEventListener('change', triggerSearch);

            // Trigger search if URL has query parameters
            if (window.location.search) {
                triggerSearch();
            }
        });

        // Helper function to get URL parameter
        function getParam(name, defaultValue) {
            const params = new URLSearchParams(window.location.search);
            return params.has(name) ? params.get(name) : defaultValue;
        }
    </script>
</body>
</html>
