<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Address Form</title>
  <style>
    ul.suggestions {
      border: 1px solid #ccc;
      max-width: 400px;
      position: absolute;
      background: #fff;
      list-style: none;
      padding: 0;
      margin: 0;
    }
    ul.suggestions li {
      padding: 8px;
      cursor: pointer;
    }
    ul.suggestions li:hover {
      background-color: #f0f0f0;
    }
    .field {
      margin-bottom: 1.5em;
      position: relative;
    }
  </style>
</head>
<body>
  <h2>German Address Form</h2>

  <div class="field">
    <label>PLZ:</label><br/>
    <input type="text" id="plz-input" autocomplete="off" style="width:400px; padding:5px;" />
    <ul id="plz-suggestions" class="suggestions"></ul>
  </div>

  <div class="field">
    <label>City:</label><br/>
    <input type="text" id="city-input" readonly style="width:400px; padding:5px; background:#eee;" />
  </div>

  <div class="field">
    <label>Street:</label><br/>
    <input type="text" id="street-input" autocomplete="off" style="width:400px; padding:5px;" />
    <ul id="street-suggestions" class="suggestions"></ul>
  </div>

  <div class="field">
    <label>House Nr:</label><br/>
    <input type="text" id="house-input" style="width:100px; padding:5px;" />
  </div>
  <script>
// Helper to clear suggestions
function clearList(el) {
  el.innerHTML = "";
}

// Render a list of items under given <ul>
function renderList(el, items, onClick) {
  clearList(el);
  items.forEach(item => {
    const li = document.createElement("li");
    li.textContent = item.display;
    li.addEventListener("click", () => onClick(item));
    el.appendChild(li);
  });
}

// Debounce factory
function debounce(fn, delay=300) {
  let timer;
  return function(...args) {
    clearTimeout(timer);
    timer = setTimeout(() => fn(...args), delay);
  };
}

// --- PLZ field ---
const plzInput = document.getElementById("plz-input");
const plzList  = document.getElementById("plz-suggestions");
const cityInput= document.getElementById("city-input");

plzInput.addEventListener("input", debounce(() => {
  const q = plzInput.value.trim();
  if (q.length < 1) { clearList(plzList); return; }

  fetch(`/autocomplete?q=${encodeURIComponent(q)}&field=plz`)
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(data => {
      renderList(plzList, data, item => {
        plzInput.value = item.postcode;
        cityInput.value = item.city;
        clearList(plzList);
      });
    })
    .catch(() => clearList(plzList));
}));

// --- Street field ---
const streetInput = document.getElementById("street-input");
const streetList  = document.getElementById("street-suggestions");

streetInput.addEventListener("input", debounce(() => {
  const q = streetInput.value.trim();
  const city = cityInput.value.trim();
  if (q.length < 1 || !city) { clearList(streetList); return; }

  fetch(`/autocomplete?q=${encodeURIComponent(q)}&field=street&city=${encodeURIComponent(city)}`)
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(data => {
      renderList(streetList, data, item => {
        streetInput.value = item.display;
        clearList(streetList);
      });
    })
    .catch(() => clearList(streetList));
}));
  </script>
</body>
</html>